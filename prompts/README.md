# Система промптов ChatGeist

## Структура файлов

```
prompts/
├── base.md                 # Базовый промпт (схема БД, SQL-примеры, форматирование)
├── README.md               # Эта документация
└── skills/
    ├── _index.md           # Индекс всех skills
    ├── dossier.md          # Досье на пользователя
    ├── summary.md          # Саммари за период
    ├── search.md           # Поиск по сообщениям
    └── top.md              # Топы и рейтинги
```

## Как это работает

1. При получении запроса бот загружает `base.md` — базовый промпт со схемой БД и инструкциями
2. Функция `detect_skill()` анализирует текст запроса на наличие триггеров
3. Если триггер найден — загружается соответствующий skill-промпт
4. Промпты комбинируются: `base + skill + история диалога + вопрос`

## Доступные Skills

| Skill | Триггеры | Описание |
|-------|----------|----------|
| `dossier` | досье, профиль, кто такой, кто такая, информация о | Создание досье на пользователя |
| `summary` | саммари, дайджест, о чём говорили, что обсуждали, главное за | Обзор обсуждений за период |
| `search` | найди, поиск, где упоминается, кто писал про | Поиск по сообщениям |
| `top` | топ, рейтинг, самые активные, популярные, больше всех | Рейтинги и статистика |

## Примеры запросов

| Запрос пользователя | Активируется skill |
|---------------------|-------------------|
| "Досье на @durov" | dossier |
| "Кто такой Павел?" | dossier |
| "О чём говорили вчера?" | summary |
| "Дайджест за неделю" | summary |
| "Найди сообщения про Python" | search |
| "Где упоминается API?" | search |
| "Топ участников" | top |
| "Самые популярные сообщения" | top |
| "Сколько сообщений в базе?" | (базовый промпт) |

## Как добавить новый Skill

### 1. Создать файл промпта

Создайте файл `prompts/skills/my_skill.md`:

```markdown
# Skill: Название

## Триггеры

Этот skill активируется при запросах вида:
- "триггер 1"
- "триггер 2"

## Инструкции

Описание того, что должен делать Claude...

### Структура ответа

Шаблон ответа...

### SQL-запросы

Примеры полезных запросов...
```

### 2. Зарегистрировать в боте

Добавьте в словарь `SKILLS` в файле `bot_multi.py`:

```python
SKILLS = {
    # ... существующие skills ...
    "my_skill": {
        "triggers": ["триггер1", "триггер2", "триггер3"],
        "file": "skills/my_skill.md"
    }
}
```

### 3. Обновить индекс (опционально)

Добавьте описание в `prompts/skills/_index.md` для документации.

## Плейсхолдеры

В `base.md` используется плейсхолдер `{db_path}`, который автоматически заменяется на путь к БД внутри Docker-контейнера.

## Конфигурация в bot_multi.py

```python
# Пути к промптам
PROMPTS_DIR = Path("prompts")

# Конфигурация Skills
SKILLS = {
    "dossier": {
        "triggers": ["досье", "профиль", "кто такой", ...],
        "file": "skills/dossier.md"
    },
    # ...
}
```

## Функции для работы с промптами

### `load_prompt(filename: str) -> str`

Загружает промпт из файла относительно `PROMPTS_DIR`.

```python
base = load_prompt("base.md")
skill = load_prompt("skills/dossier.md")
```

### `detect_skill(query: str) -> str | None`

Определяет подходящий skill на основе триггеров в тексте запроса.

```python
skill = detect_skill("Досье на @durov")  # -> "dossier"
skill = detect_skill("Сколько сообщений?")  # -> None
```
