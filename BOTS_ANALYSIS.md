# Анализ Telegram ботов ChatGeist

## Обзор

В проекте представлено 5 вариантов Telegram бота для анализа сообщений из SQLite базы данных с использованием различных AI-провайдеров.

---

## 1. bot_with_claude_cli.py

**Тип:** Базовый бот с Claude CLI

**AI-провайдер:** Claude CLI (локальный)

**Особенности:**
- Простейшая реализация
- Использует внешний модуль `ask_claude_cli.py`
- Нет поддержки истории диалога
- Прямой вызов Claude CLI на хост-машине

**Безопасность:** Низкая - Claude CLI имеет полный доступ к системе

**Плюсы:**
- Простота реализации
- Минимум зависимостей

**Минусы:**
- Нет контекста диалога
- Небезопасно для production

---

## 2. bot_advanced.py

**Тип:** Расширенный бот с Claude CLI

**AI-провайдер:** Claude CLI (локальный)

**Особенности:**
- Поддержка контекстных диалогов через reply
- Сбор истории сообщений из цепочки ответов
- Формирование промпта с историей
- Прямой вызов Claude CLI на хост-машине

**Безопасность:** Низкая - Claude CLI имеет полный доступ к системе

**Плюсы:**
- Поддержка контекста диалога
- Автоматическое переключение Markdown/plain text

**Минусы:**
- Небезопасно для production
- Нет изоляции

---

## 3. bot_secure.py

**Тип:** Безопасный бот с Docker sandbox

**AI-провайдер:** Claude CLI в Docker контейнере

**Особенности:**
- Claude CLI запускается в изолированном Docker контейнере
- БД монтируется в режиме read-only
- Поддержка контекстных диалогов
- Таймаут 5 минут
- Проверка наличия контейнера при старте

**Безопасность:** Высокая - изоляция через Docker

**Плюсы:**
- Безопасное выполнение
- Ограниченный доступ к файловой системе
- Поддержка контекста

**Минусы:**
- Требует Docker
- Сложнее в настройке
- Проблемы с монтированием конфигов Claude

---

## 4. bot_secure_simple.py

**Тип:** Упрощённый безопасный бот

**AI-провайдер:** Claude CLI в Docker контейнере

**Особенности:**
- Аналогичен bot_secure.py
- Упрощённое форматирование (plain text)
- Инструкция Claude не использовать Markdown
- Использует эмодзи для структурирования

**Безопасность:** Высокая - изоляция через Docker

**Плюсы:**
- Нет проблем с рендерингом Markdown в Telegram
- Стабильный вывод

**Минусы:**
- Менее красивое форматирование

---

## 5. bot_gemini.py

**Тип:** Бот с Google Gemini API

**AI-провайдер:** Google Gemini 2.5 Pro Preview

**Особенности:**
- Использует Gemini API вместо Claude
- Двухэтапный процесс: генерация SQL -> анализ результатов
- Читает схему БД и примеры данных
- Выполняет SQL запросы локально через sqlite3
- Поддержка контекстных диалогов

**Безопасность:** Средняя - SQL выполняется локально, но без песочницы

**Плюсы:**
- Не требует Claude CLI
- Работает через API
- Более предсказуемый SQL-подход

**Минусы:**
- Требует GEMINI_API_KEY
- Два API-вызова на запрос
- Нет изоляции SQL-запросов

---

## 6. bot_openai.py

**Тип:** Бот с OpenAI API

**AI-провайдер:** OpenAI GPT-4o-mini

**Особенности:**
- Использует OpenAI API
- Аналогичная логика с Gemini ботом
- Двухэтапный процесс: SQL -> анализ
- Модель gpt-4o-mini (быстрая и недорогая)
- Поддержка контекстных диалогов

**Безопасность:** Средняя - SQL выполняется локально, но без песочницы

**Плюсы:**
- Стабильный API
- Быстрая модель
- Хорошее качество SQL-генерации

**Минусы:**
- Платный API
- Нет изоляции SQL-запросов

---

## Сравнительная таблица

| Бот | AI-провайдер | Контекст | Безопасность | Docker | SQL-подход |
|-----|-------------|----------|--------------|--------|------------|
| bot_with_claude_cli | Claude CLI | Нет | Низкая | Нет | Агентный |
| bot_advanced | Claude CLI | Да | Низкая | Нет | Агентный |
| bot_secure | Claude CLI | Да | Высокая | Да | Агентный |
| bot_secure_simple | Claude CLI | Да | Высокая | Да | Агентный |
| bot_gemini | Gemini API | Да | Средняя | Нет | Генерация SQL |
| bot_openai | OpenAI API | Да | Средняя | Нет | Генерация SQL |

---

## Рекомендации

### Для разработки:
- `bot_advanced.py` - быстрый старт, полный доступ Claude к системе

### Для production:
- `bot_secure_simple.py` - максимальная безопасность через Docker

### Для экономии:
- `bot_openai.py` с gpt-4o-mini - низкая стоимость API

### Для качества:
- `bot_gemini.py` с Gemini 2.5 Pro - мощная модель

---

## Общие компоненты

Все боты используют:
- **aiogram** - асинхронный фреймворк для Telegram
- **python-dotenv** - загрузка переменных окружения
- **sqlite3** - работа с базой данных
- Общую структуру обработчиков (`/start`, текстовые сообщения)
- Разбиение длинных ответов на части (лимит Telegram 4096 символов)
