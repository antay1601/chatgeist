# –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ ChatGeist Bot

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

aiogram –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π async-–∑–∞–¥–∞—á–µ:

```
User A: "–¥–æ—Å—å–µ –Ω–∞ @x"     ‚îÄ‚îÄ‚ñ∫ Task A ‚îÄ‚îÄ‚ñ∫ subprocess A ‚îÄ‚îÄ‚ñ∫ status_msg A
User B: "—Ç–æ–ø —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"  ‚îÄ‚îÄ‚ñ∫ Task B ‚îÄ‚îÄ‚ñ∫ subprocess B ‚îÄ‚îÄ‚ñ∫ status_msg B
User C: "–ø–æ–∏—Å–∫ Python"    ‚îÄ‚îÄ‚ñ∫ Task C ‚îÄ‚îÄ‚ñ∫ subprocess C ‚îÄ‚îÄ‚ñ∫ status_msg C
```

## –ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–æ:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|----------|
| `status_msg` | –°–≤–æ—ë —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º –≤ Telegram |
| `status_callback` | Closure –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `status_msg` |
| FSM state | –•—Ä–∞–Ω–∏—Ç—Å—è –ø–æ `user_id` (–≤—ã–±—Ä–∞–Ω–Ω—ã–π —á–∞—Ç) |
| subprocess | –°–≤–æ–π –ø—Ä–æ—Ü–µ—Å—Å Claude CLI –≤ Docker |

–ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç:
- –°–≤–æ–π —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (üîç ‚Üí üìä ‚Üí ü§î ‚Üí ‚úèÔ∏è)
- –°–≤–æ–π —Ç–∞–π–º–µ—Ä
- –°–≤–æ–π –æ—Ç–≤–µ—Ç/PDF

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤

| –†–µ—Å—É—Ä—Å | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ | –í–ª–∏—è–Ω–∏–µ |
|--------|-------------|---------|
| Docker CPU/RAM | –ù–µ—Å–∫–æ–ª—å–∫–æ Claude CLI –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ | –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ –ø—Ä–∏ 5+ –∑–∞–ø—Ä–æ—Å–∞—Ö |
| Thread pool | ~4-8 –ø–æ—Ç–æ–∫–æ–≤ (–ø–æ —è–¥—Ä–∞–º CPU) | –û—á–µ—Ä–µ–¥—å –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ |
| Claude API rate limits | –õ–∏–º–∏—Ç—ã Anthropic | 429 Too Many Requests |
| OAuth —Ç–æ–∫–µ–Ω | –û–¥–∏–Ω –Ω–∞ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã | –û–±—â–∏–π rate limit |
| –ü–∞–º—è—Ç—å | ~100-200MB –Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å | OOM –ø—Ä–∏ –º–Ω–æ–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö |

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
–ü—Ä–∏ 5+ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–æ–ª—å—à–µ –∏–∑-–∑–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ –∑–∞ —Ä–µ—Å—É—Ä—Å—ã.

### 2. Rate limits Claude API
Claude API –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É 429 –ø—Ä–∏ —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö.

### 3. –ù–µ—Ö–≤–∞—Ç–∫–∞ –ø–∞–º—è—Ç–∏
–ö–∞–∂–¥—ã–π –ø—Ä–æ—Ü–µ—Å—Å Claude CLI –ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç ~100-200MB. –ü—Ä–∏ 10 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö —ç—Ç–æ 1-2GB RAM.

### 4. Timeout
–î–æ–ª–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –Ω–µ —É—Å–ø–µ—Ç—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è –∑–∞ 20 –º–∏–Ω—É—Ç (—Ç–µ–∫—É—â–∏–π —Ç–∞–π–º–∞—É—Ç).

## –†–µ—à–µ–Ω–∏–µ: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–º–∞—Ñ–æ—Ä:

```python
from asyncio import Semaphore

# –í –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞ bot_multi.py
claude_semaphore = Semaphore(3)  # –ú–∞–∫—Å 3 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞ –∫ Claude

# –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ handle_query
async with claude_semaphore:
    report = await ask_claude_streaming(user_query, history, current_db, update_status)
```

### –ß—Ç–æ —ç—Ç–æ –¥–∞—ë—Ç

- –ù–µ –±–æ–ª–µ–µ 3 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Claude –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –û—Å—Ç–∞–ª—å–Ω—ã–µ –∂–¥—É—Ç –≤ –æ—á–µ—Ä–µ–¥–∏
- –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ –∏ rate limits

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–± –æ—á–µ—Ä–µ–¥–∏

```python
claude_semaphore = Semaphore(3)

# –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ
if claude_semaphore.locked():
    await status_msg.edit_text("‚è≥ –û—á–µ—Ä–µ–¥—å... –í–∞—à –∑–∞–ø—Ä–æ—Å –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç")

async with claude_semaphore:
    report = await ask_claude_streaming(...)
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏

```python
import logging
logger = logging.getLogger(__name__)

# –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∑–∞–ø—Ä–æ—Å–∞
logger.info(f"–ó–∞–ø—Ä–æ—Å –æ—Ç user_id={user_id}, –∞–∫—Ç–∏–≤–Ω—ã—Ö: {3 - claude_semaphore._value}")

# –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
logger.info(f"–ó–∞–≤–µ—Ä—à—ë–Ω –∑–∞–ø—Ä–æ—Å user_id={user_id}, –≤—Ä–µ–º—è: {elapsed}s")
```

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è prometheus (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```python
from prometheus_client import Counter, Histogram, Gauge

requests_total = Counter('chatgeist_requests_total', 'Total requests')
request_duration = Histogram('chatgeist_request_duration_seconds', 'Request duration')
active_requests = Gauge('chatgeist_active_requests', 'Currently active requests')
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é

### –ú–∞–ª–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (< 10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π/—á–∞—Å)
- –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞
- –°–µ–º–∞—Ñ–æ—Ä –Ω–µ –Ω—É–∂–µ–Ω

### –°—Ä–µ–¥–Ω—è—è –Ω–∞–≥—Ä—É–∑–∫–∞ (10-100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π/—á–∞—Å)
- –î–æ–±–∞–≤–∏—Ç—å —Å–µ–º–∞—Ñ–æ—Ä —Å –ª–∏–º–∏—Ç–æ–º 3-5
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ rate limits

### –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (100+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π/—á–∞—Å)
- –ù–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ –±–æ—Ç–∞
- –û—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á (Redis/RabbitMQ)
- –û—Ç–¥–µ–ª—å–Ω—ã–π –≤–æ—Ä–∫–µ—Ä –¥–ª—è Claude –∑–∞–ø—Ä–æ—Å–æ–≤
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
