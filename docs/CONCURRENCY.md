# –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ ChatGeist Bot

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

aiogram –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π async-–∑–∞–¥–∞—á–µ:

```
User A: "–¥–æ—Å—å–µ –Ω–∞ @x"     ‚îÄ‚îÄ‚ñ∫ Task A ‚îÄ‚îÄ‚ñ∫ Anthropic API ‚îÄ‚îÄ‚ñ∫ status_msg A
User B: "—Ç–æ–ø —É—á–∞—Å—Ç–Ω–∏–∫—ñ–≤"  ‚îÄ‚îÄ‚ñ∫ Task B ‚îÄ‚îÄ‚ñ∫ Anthropic API ‚îÄ‚îÄ‚ñ∫ status_msg B
User C: "–ø–æ—à—É–∫ Python"    ‚îÄ‚îÄ‚ñ∫ Task C ‚îÄ‚îÄ‚ñ∫ Anthropic API ‚îÄ‚îÄ‚ñ∫ status_msg C
```

## –ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–æ:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|----------|
| `status_msg` | –°–≤–æ—ë —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º –≤ Telegram |
| `status_callback` | Closure –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `status_msg` |
| FSM state | –•—Ä–∞–Ω–∏—Ç—Å—è –ø–æ `user_id` (–≤—ã–±—Ä–∞–Ω–Ω—ã–π —á–∞—Ç) |
| API request | –°–≤–æ–π HTTP –∑–∞–ø—Ä–æ—Å –∫ Anthropic API |

–ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç:
- –°–≤–æ–π —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (üîç ‚Üí üìä ‚Üí ü§î ‚Üí ‚úèÔ∏è)
- –°–≤–æ–π —Ç–∞–π–º–µ—Ä
- –°–≤–æ–π –æ—Ç–≤–µ—Ç/PDF

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤

| –†–µ—Å—É—Ä—Å | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ | –í–ª–∏—è–Ω–∏–µ |
|--------|-------------|---------|
| Anthropic API rate limits | –õ–∏–º–∏—Ç—ã –ø–æ —Ç–æ–∫–µ–Ω–∞–º/–∑–∞–ø—Ä–æ—Å–∞–º | 429 Too Many Requests |
| API Key tier | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Ä–æ–≤–Ω—è –ø–æ–¥–ø–∏—Å–∫–∏ | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ |
| –ü–∞–º—è—Ç—å | ~50-100MB –Ω–∞ –∑–∞–ø—Ä–æ—Å | –î–ª—è –±–æ–ª—å—à–∏—Ö SQL —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ |

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. Rate limits Anthropic API
Claude API –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É 429 –ø—Ä–∏ —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö.

### 2. –ë–æ–ª—å—à–∏–µ SQL —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
–ï—Å–ª–∏ SQL –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–Ω–æ–≥–æ –¥–∞–Ω–Ω—ã—Ö, —ç—Ç–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å.

### 3. Timeout
–î–æ–ª–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –Ω–µ —É—Å–ø–µ—Ç—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è (API timeout ~10 –º–∏–Ω—É—Ç).

## –†–µ—à–µ–Ω–∏–µ: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–º–∞—Ñ–æ—Ä:

```python
from asyncio import Semaphore

# –í –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞ bot_multi.py
claude_semaphore = Semaphore(3)  # –ú–∞–∫—Å 3 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞ –∫ Claude

# –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ handle_query
async with claude_semaphore:
    report = await ask_claude_api(user_query, history, current_db, status_msg.message_id, update_status)
```

### –ß—Ç–æ —ç—Ç–æ –¥–∞—ë—Ç

- –ù–µ –±–æ–ª–µ–µ 3 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Claude –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –û—Å—Ç–∞–ª—å–Ω—ã–µ –∂–¥—É—Ç –≤ –æ—á–µ—Ä–µ–¥–∏
- –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ –∏ rate limits

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–± –æ—á–µ—Ä–µ–¥–∏

```python
claude_semaphore = Semaphore(3)

# –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ
if claude_semaphore.locked():
    await status_msg.edit_text("‚è≥ –ß–µ—Ä–≥–∞... –í–∞—à –∑–∞–ø–∏—Ç –±—É–¥–µ –æ–±—Ä–æ–±–ª–µ–Ω–æ –∑–∞ –∫—ñ–ª—å–∫–∞ —Ö–≤–∏–ª–∏–Ω")

async with claude_semaphore:
    report = await ask_claude_api(...)
```

## –°–∏—Å—Ç–µ–º–∞ –ª–∏–º–∏—Ç–æ–≤

–í –±–æ—Ç–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –ª–∏–º–∏—Ç–æ–≤:

```python
# Whitelist –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–±–µ–∑ –ª–∏–º–∏—Ç–æ–≤)
WHITELIST_USER_IDS = {
    435878873,  # @tarados
    354910522,  # @dadonius
}

# –õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
DAILY_LIMIT = 5
```

–≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ API.

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏

```python
import logging
logger = logging.getLogger(__name__)

# –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∑–∞–ø—Ä–æ—Å–∞
logger.info(f"–ó–∞–ø—Ä–æ—Å –æ—Ç user_id={user_id}")

# –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
logger.info(f"–ó–∞–≤–µ—Ä—à—ë–Ω –∑–∞–ø—Ä–æ—Å user_id={user_id}, –≤—Ä–µ–º—è: {elapsed}s")
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞—Å—Ö–æ–¥–æ–≤

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API:
- https://console.anthropic.com/settings/billing

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é

### –ú–∞–ª–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (< 10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π/—á–∞—Å)
- –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞
- –°–µ–º–∞—Ñ–æ—Ä –Ω–µ –Ω—É–∂–µ–Ω

### –°—Ä–µ–¥–Ω—è—è –Ω–∞–≥—Ä—É–∑–∫–∞ (10-100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π/—á–∞—Å)
- –î–æ–±–∞–≤–∏—Ç—å —Å–µ–º–∞—Ñ–æ—Ä —Å –ª–∏–º–∏—Ç–æ–º 3-5
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ rate limits

### –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (100+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π/—á–∞—Å)
- –ù–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ –±–æ—Ç–∞
- –û—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á (Redis/RabbitMQ)
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
